<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Search Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f5f6fa;
  --bg2:#ffffff;
  --surface:#ffffff;
  --surface2:#f8f9fd;
  --surface3:#f0f2f8;
  --border:#e2e6f0;
  --border2:#c8cfe0;
  --accent:#3b7ef6;
  --accent2:#7c5cf6;
  --accent3:#0cb87a;
  --acg:linear-gradient(135deg,#3b7ef6,#7c5cf6);
  --red:#e85454;
  --yellow:#f59e0b;
  --text:#1a2340;
  --text2:#5a6a8a;
  --text3:#a0aec0;
  --shadow:0 1px 4px rgba(0,0,0,.08);
  --shadow2:0 4px 20px rgba(0,0,0,.1);
}
html{font-size:14px}
body{background:var(--bg);color:var(--text);font-family:'Pretendard',sans-serif;min-height:100vh;display:flex}

/* â”€â”€ SIDEBAR â”€â”€ */
.sb{
  width:272px;flex-shrink:0;
  background:var(--bg2);
  border-right:1px solid var(--border);
  height:100vh;position:sticky;top:0;
  display:flex;flex-direction:column;overflow:hidden;
  box-shadow:2px 0 12px rgba(0,0,0,.04);
}
.sb-scroll{flex:1;overflow-y:auto;padding:0 0 28px}
.sb-scroll::-webkit-scrollbar{width:3px}
.sb-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

.sb-logo{
  padding:20px 20px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;flex-shrink:0;
}
.sb-logo-icon{
  width:32px;height:32px;border-radius:9px;
  background:var(--acg);
  display:grid;place-items:center;font-size:16px;flex-shrink:0;
  box-shadow:0 2px 8px rgba(59,126,246,.3);
}
.logo-name{font-size:15px;font-weight:700;letter-spacing:-.02em;color:var(--text)}
.logo-sub{font-size:10px;color:var(--text3);margin-top:1px}

.sec{padding:16px 18px 0}
.lbl{
  font-size:9.5px;letter-spacing:.1em;text-transform:uppercase;
  color:var(--text3);margin-bottom:9px;font-weight:600;
}

/* Mode tabs */
.tabs{
  display:grid;grid-template-columns:1fr 1fr;
  background:var(--surface3);border:1px solid var(--border);
  border-radius:10px;padding:3px;margin-bottom:16px;
}
.tab{
  padding:7px;text-align:center;font-size:12px;font-weight:600;
  cursor:pointer;border-radius:7px;color:var(--text2);
  border:none;background:transparent;font-family:inherit;transition:all .2s;
}
.tab.on{
  background:var(--acg);color:#fff;
  box-shadow:0 2px 8px rgba(59,126,246,.3);
}

/* API Panel */
.api-panel{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;overflow:hidden;margin-bottom:16px;
}
.api-hd{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 13px;cursor:pointer;transition:background .15s;
}
.api-hd:hover{background:var(--surface3)}
.api-st{display:flex;align-items:center;gap:7px;font-size:12px;font-weight:500;color:var(--text)}
.dot{width:7px;height:7px;border-radius:50%;background:var(--red);flex-shrink:0}
.dot.ok{background:var(--accent3)}
.caret{font-size:9px;color:var(--text3);transition:transform .2s}
.caret.open{transform:rotate(180deg)}
.api-bd{display:none;padding:12px 13px;border-top:1px solid var(--border)}
.api-bd.open{display:block}

.fld{margin-bottom:9px}
.fld label{display:block;font-size:10px;color:var(--text2);margin-bottom:4px;letter-spacing:.04em;text-transform:uppercase;font-weight:600}
.fld input{
  width:100%;background:#fff;
  border:1px solid var(--border);border-radius:7px;
  color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;
  padding:7px 9px;outline:none;transition:border-color .2s;
  box-shadow:inset 0 1px 3px rgba(0,0,0,.04);
}
.fld input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,126,246,.1)}
.fld input::placeholder{color:var(--text3)}

.guide-box{
  background:rgba(59,126,246,.05);border:1px solid rgba(59,126,246,.15);
  border-radius:8px;padding:10px 11px;font-size:11px;color:var(--text2);
  line-height:1.8;margin:8px 0;
}
.guide-box a{color:var(--accent);text-decoration:none}
.guide-box a:hover{text-decoration:underline}
.free-badge{
  display:inline-block;background:rgba(12,184,122,.12);border:1px solid rgba(12,184,122,.3);
  color:var(--accent3);border-radius:4px;padding:1px 7px;
  font-size:10px;font-weight:700;margin-bottom:6px;
}
.save-btn{
  width:100%;padding:8px;
  background:var(--accent);border:none;
  border-radius:7px;color:#fff;
  font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;
  transition:all .2s;margin-top:8px;
  box-shadow:0 2px 8px rgba(59,126,246,.3);
}
.save-btn:hover{background:#2d6de0;box-shadow:0 4px 12px rgba(59,126,246,.4)}

/* Sites */
.sites-list{margin-bottom:7px}
.site-row{
  display:flex;align-items:center;gap:7px;
  padding:7px 9px;
  background:#fff;border:1px solid var(--border);
  border-radius:8px;margin-bottom:4px;
  transition:all .15s;box-shadow:var(--shadow);
}
.site-row:hover{border-color:var(--border2);box-shadow:0 2px 8px rgba(0,0,0,.08)}
.cb{
  width:15px;height:15px;border-radius:4px;
  border:1.5px solid var(--border2);flex-shrink:0;
  display:grid;place-items:center;cursor:pointer;transition:all .18s;
}
.cb.on{background:var(--acg);border-color:transparent}
.cb.on::after{content:'âœ“';font-size:8.5px;color:#fff;font-weight:700}
.site-name{
  font-family:'JetBrains Mono',monospace;font-size:11px;
  color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.del-btn{
  width:16px;height:16px;border:none;background:transparent;
  color:var(--text3);cursor:pointer;font-size:14px;
  border-radius:3px;transition:all .15s;display:grid;place-items:center;flex-shrink:0;
}
.del-btn:hover{color:var(--red);background:rgba(232,84,84,.1)}

.add-row{display:flex;gap:5px}
.add-inp{
  flex:1;background:#fff;border:1px solid var(--border);
  border-radius:7px;color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:11px;
  padding:6px 9px;outline:none;transition:border-color .2s;
  box-shadow:inset 0 1px 3px rgba(0,0,0,.04);
}
.add-inp:focus{border-color:var(--accent)}
.add-inp::placeholder{color:var(--text3)}
.add-btn{
  width:30px;flex-shrink:0;
  background:var(--accent);border:none;
  border-radius:7px;color:#fff;font-size:15px;cursor:pointer;
  transition:all .15s;display:grid;place-items:center;
}
.add-btn:hover{background:#2d6de0}
.hint{font-size:10px;color:var(--text3);margin-top:5px;line-height:1.5}

/* General info */
.infobox{
  background:rgba(12,184,122,.06);border:1px solid rgba(12,184,122,.2);
  border-radius:9px;padding:10px 12px;font-size:11px;color:#1a7a5a;line-height:1.75;
}

/* Sort */
.sort-row{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:18px}
.s-btn{
  padding:7px 0;text-align:center;font-size:11px;font-weight:600;cursor:pointer;
  border-radius:8px;border:1px solid var(--border);
  background:#fff;color:var(--text2);font-family:inherit;transition:all .18s;
  box-shadow:var(--shadow);
}
.s-btn:hover{border-color:var(--border2);color:var(--text)}
.s-btn.on{
  background:rgba(59,126,246,.1);border-color:rgba(59,126,246,.4);
  color:var(--accent);box-shadow:none;
}

/* Usage */
.usage-bar{
  margin:8px 18px 16px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:9px;padding:10px 12px;
}
.usage-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.usage-lbl{font-size:10px;color:var(--text2)}
.usage-cnt{font-size:11px;font-weight:700;color:var(--text)}
.usage-track{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.usage-fill{height:100%;background:var(--acg);border-radius:2px;transition:width .4s}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;min-width:0}
.topbar{
  position:sticky;top:0;z-index:9;
  background:rgba(255,255,255,.92);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);padding:16px 26px;
  box-shadow:0 1px 8px rgba(0,0,0,.05);
}
.search-row{display:flex;gap:9px;align-items:center}
.search-box{
  flex:1;display:flex;align-items:center;
  background:#fff;border:1px solid var(--border);
  border-radius:11px;overflow:hidden;transition:all .2s;
  box-shadow:var(--shadow);
}
.search-box:focus-within{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(59,126,246,.12);
}
.s-ico{padding:0 13px;color:var(--text3);font-size:15px;flex-shrink:0}
.s-inp{
  flex:1;background:transparent;border:none;
  color:var(--text);font-family:inherit;font-size:15px;
  padding:13px 0;outline:none;
}
.s-inp::placeholder{color:var(--text3)}
.go{
  flex-shrink:0;background:var(--acg);border:none;border-radius:9px;
  color:#fff;font-family:inherit;font-weight:700;font-size:13px;
  padding:0 22px;height:42px;cursor:pointer;
  box-shadow:0 2px 12px rgba(59,126,246,.35);transition:all .18s;white-space:nowrap;
}
.go:hover{transform:translateY(-1px);box-shadow:0 4px 18px rgba(59,126,246,.45)}
.go:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

.chips{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.chip{
  display:inline-flex;align-items:center;gap:5px;
  background:var(--surface3);border:1px solid var(--border);
  border-radius:20px;padding:3px 10px;font-size:10.5px;color:var(--text2);
}
.chip .cd{width:5px;height:5px;border-radius:50%}

.content{flex:1;padding:22px 26px 60px}

/* States */
.state{text-align:center;padding:80px 20px;animation:fu .4s ease both}
.state-ico{font-size:36px;margin-bottom:13px}
.state-title{font-size:15px;font-weight:600;color:var(--text2);margin-bottom:7px}
.state-sub{font-size:12px;color:var(--text3);line-height:1.8}
.spin{
  width:32px;height:32px;
  border:2.5px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 13px;
}
.err{
  background:#fff5f5;border:1px solid rgba(232,84,84,.25);
  border-radius:10px;color:var(--red);font-size:12.5px;
  padding:12px 15px;margin-bottom:12px;animation:fu .3s ease both;line-height:1.65;
}

/* Result info */
.rinfo{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;flex-wrap:wrap;gap:7px;
}
.rcnt{font-size:12.5px;color:var(--text2)}
.rcnt strong{color:var(--text)}
.rq{
  font-family:'JetBrains Mono',monospace;font-size:10.5px;
  color:var(--accent);background:rgba(59,126,246,.07);
  border:1px solid rgba(59,126,246,.2);border-radius:6px;
  padding:3px 9px;max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

/* Cards */
.card{
  background:#fff;border:1px solid var(--border);
  border-radius:12px;padding:16px 18px;margin-bottom:8px;
  text-decoration:none;display:block;
  transition:all .2s;animation:fu .35s ease both;
  box-shadow:var(--shadow);
}
.card:hover{
  border-color:rgba(59,126,246,.3);
  transform:translateY(-2px);
  box-shadow:0 6px 24px rgba(59,126,246,.1);
}
.card-in{display:flex;gap:14px;align-items:flex-start}
.card-body{flex:1;min-width:0}
.card-top{display:flex;align-items:center;gap:7px;margin-bottom:7px;flex-wrap:wrap}
.card-dom{
  font-size:10px;color:var(--text2);font-family:'JetBrains Mono',monospace;
  background:var(--surface3);border:1px solid var(--border);
  border-radius:5px;padding:2px 7px;
}
.card-rel{font-size:10px;color:var(--text3)}
.card-title{
  font-size:14.5px;font-weight:600;color:var(--text);
  line-height:1.45;margin-bottom:6px;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;
  transition:color .2s;
}
.card:hover .card-title{color:var(--accent)}
.card-desc{
  font-size:12px;color:var(--text2);line-height:1.75;
  display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
}

/* Date badge */
.dbadge{
  flex-shrink:0;
  background:var(--surface3);border:1px solid var(--border);
  border-radius:9px;padding:9px 11px;text-align:center;min-width:62px;
}
.db-d{font-size:19px;font-weight:700;color:var(--text);line-height:1}
.db-m{font-size:9px;color:var(--text2);margin-top:2px;text-transform:uppercase;letter-spacing:.04em}
.db-y{font-size:9px;color:var(--text3)}
.db-na{font-size:20px;color:var(--text3);line-height:1;padding:4px 0}

/* Pagination */
.pager{display:flex;justify-content:center;gap:5px;margin-top:24px}
.pg{
  min-width:36px;height:36px;
  background:#fff;border:1px solid var(--border);
  border-radius:8px;color:var(--text2);cursor:pointer;
  font-size:12.5px;font-family:inherit;transition:all .15s;
  box-shadow:var(--shadow);
}
.pg:hover{border-color:var(--accent);color:var(--accent)}
.pg.on{
  background:var(--accent);border-color:var(--accent);
  color:#fff;font-weight:700;box-shadow:0 2px 8px rgba(59,126,246,.3);
}

/* Mobile */
.sb-toggle{
  display:none;position:fixed;bottom:20px;right:20px;z-index:20;
  width:44px;height:44px;border-radius:11px;
  background:var(--acg);border:none;color:#fff;font-size:17px;cursor:pointer;
  box-shadow:0 4px 16px rgba(59,126,246,.4);place-items:center;
}
@media(max-width:720px){
  .sb{position:fixed;left:0;top:0;bottom:0;z-index:15;transform:translateX(-100%);transition:transform .28s}
  .sb.open{transform:translateX(0)}
  .main{margin-left:0}
  .topbar{padding:12px 14px}
  .content{padding:16px 14px 60px}
  .sb-toggle{display:grid}
}
@keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<nav class="sb" id="sb">
  <div class="sb-logo">
    <div class="sb-logo-icon">ğŸ”</div>
    <div>
      <div class="logo-name">Search Pro</div>
      <div class="logo-sub">Powered by Serper.dev (Google)</div>
    </div>
  </div>

  <div class="sb-scroll">
    <div class="sec">

      <!-- Mode -->
      <div class="lbl">ê²€ìƒ‰ ëª¨ë“œ</div>
      <div class="tabs">
        <button class="tab on" id="t-site" onclick="setMode('site')">ğŸ—‚ ì‚¬ì´íŠ¸ ê²€ìƒ‰</button>
        <button class="tab" id="t-gen" onclick="setMode('general')">ğŸŒ ì¼ë°˜ ê²€ìƒ‰</button>
      </div>

      <!-- API Key -->
      <div class="lbl">API ì„¤ì •</div>
      <div class="api-panel">
        <div class="api-hd" onclick="toggleApi()">
          <div class="api-st"><div class="dot" id="api-dot"></div><span id="api-lbl">Serper API í‚¤ í•„ìš”</span></div>
          <span class="caret" id="api-caret">â–¾</span>
        </div>
        <div class="api-bd" id="api-bd">
          <div class="fld">
            <label>Serper.dev API Key</label>
            <input type="password" id="skey" placeholder="API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
          </div>
          <div class="guide-box">
            <div class="free-badge">âœ“ ì™„ì „ ë¬´ë£Œ Â· ì‹ ìš©ì¹´ë“œ ë¶ˆí•„ìš”</div><br>
            1. <a href="https://serper.dev" target="_blank">serper.dev</a> ì—ì„œ ì´ë©”ì¼ë¡œ ê°€ì…<br>
            2. ëŒ€ì‹œë³´ë“œ â†’ <strong>API Key</strong> ë³µì‚¬<br>
            3. ìœ„ì— ë¶™ì—¬ë„£ê³  ì €ì¥<br>
            <span style="color:var(--text3)">ê°€ì… ì¦‰ì‹œ 2,500ê±´ ë¬´ë£Œ ì œê³µ</span>
          </div>
          <button class="save-btn" onclick="saveCfg()">ğŸ’¾ ì €ì¥ (ë¸Œë¼ìš°ì €ì— ë³´ê´€)</button>
        </div>
      </div>

      <!-- Sites panel -->
      <div id="sites-panel">
        <div class="lbl">ê²€ìƒ‰ ì‚¬ì´íŠ¸ <span style="color:var(--text3);font-size:9px">ì²´í¬ëœ ì‚¬ì´íŠ¸ë§Œ ê²€ìƒ‰</span></div>
        <div class="sites-list" id="sites-list"></div>
        <div class="add-row">
          <input class="add-inp" id="new-site" placeholder="ì˜ˆ: tistory.com/myblog" onkeydown="if(event.key==='Enter')addSite()">
          <button class="add-btn" onclick="addSite()">+</button>
        </div>
        <div class="hint">http:// ì—†ì´ ì…ë ¥ Â· ì—¬ëŸ¬ ì‚¬ì´íŠ¸ ë™ì‹œ ê²€ìƒ‰ ê°€ëŠ¥</div>
      </div>

      <!-- General panel -->
      <div id="gen-panel" style="display:none">
        <div class="infobox">
          ğŸ“° ì£¼ìš” ë‰´ìŠ¤ ì–¸ë¡ ì‚¬ ìë™ ì œì™¸<br>
          <span style="font-size:10px;opacity:.75">ë„¤ì´ë²„ë‰´ìŠ¤Â·ë‹¤ìŒë‰´ìŠ¤Â·ì¡°ì„ Â·ì¤‘ì•™Â·ë™ì•„Â·í•œê²¨ë ˆÂ·ì—°í•©ë‰´ìŠ¤Â·KBSÂ·MBCÂ·SBSÂ·BloombergÂ·CNNÂ·Reuters ë“±</span>
        </div>
      </div>

      <!-- Sort -->
      <div class="lbl" style="margin-top:16px">ì •ë ¬</div>
      <div class="sort-row">
        <button class="s-btn on" id="s-rel" onclick="setSort('rel')">ê´€ë ¨ë„</button>
        <button class="s-btn" id="s-new" onclick="setSort('new')">ìµœì‹ ìˆœ</button>
        <button class="s-btn" id="s-old" onclick="setSort('old')">ì˜¤ë˜ëœìˆœ</button>
      </div>

    </div>

    <!-- Usage -->
    <div class="usage-bar" id="usage-bar" style="display:none">
      <div class="usage-top">
        <span class="usage-lbl">ì„¸ì…˜ ì‚¬ìš©ëŸ‰</span>
        <span class="usage-cnt" id="usage-cnt">0 / 2,500</span>
      </div>
      <div class="usage-track"><div class="usage-fill" id="usage-fill" style="width:0%"></div></div>
    </div>

  </div>
</nav>

<button class="sb-toggle" onclick="document.getElementById('sb').classList.toggle('open')">â˜°</button>

<main class="main">
  <div class="topbar">
    <div class="search-row">
      <div class="search-box">
        <div class="s-ico">ğŸ”</div>
        <input class="s-inp" id="q" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”â€¦" onkeydown="if(event.key==='Enter')go(1)">
      </div>
      <button class="go" id="go-btn" onclick="go(1)">ê²€ìƒ‰</button>
    </div>
    <div class="chips" id="chips" style="display:none">
      <div class="chip" id="chip-mode"><div class="cd" id="cd-mode"></div><span id="chip-mode-txt"></span></div>
      <div class="chip"><div class="cd" style="background:var(--accent2)"></div><span id="chip-sort-txt"></span></div>
    </div>
  </div>

  <div class="content">
    <div class="state" id="welcome">
      <div class="state-ico">ğŸ”</div>
      <div class="state-title">ê²€ìƒ‰ì„ ì‹œì‘í•´ ë³´ì„¸ìš”</div>
      <div class="state-sub">
        API í‚¤ë¥¼ ì„¤ì •í•˜ê³ <br>
        ì‚¬ì´íŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì¼ë°˜ ê²€ìƒ‰ ëª¨ë“œë¥¼<br>
        ì„ íƒí•œ í›„ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”
      </div>
    </div>
    <div id="out"></div>
  </div>
</main>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mode='site', sort='rel', usageCount=0;

const NEWS=[
  'news.naver.com','news.daum.net','chosun.com','joongang.co.kr','donga.com',
  'hani.co.kr','khan.co.kr','hankyung.com','mk.co.kr','mt.co.kr','sedaily.com',
  'yna.co.kr','yonhapnews.co.kr','kbs.co.kr','mbc.co.kr','sbs.co.kr',
  'joins.com','newsis.com','ohmynews.com','pressian.com','hankookilbo.com',
  'bbc.com','reuters.com','apnews.com','bloomberg.com','cnbc.com',
  'cnn.com','nytimes.com','washingtonpost.com','theguardian.com','wsj.com',
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STORAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function load(){
  try{
    const c=JSON.parse(localStorage.getItem('sp4_cfg')||'{}');
    if(c.skey) document.getElementById('skey').value=c.skey;
    updateDot();
    const s=JSON.parse(localStorage.getItem('sp4_sites')||'[]');
    s.forEach(x=>addToList(x.url,x.on));
    usageCount=parseInt(localStorage.getItem('sp4_usage')||'0');
    updateUsage();
  }catch(e){}
}
function saveCfg(){
  const k=document.getElementById('skey').value.trim();
  if(!k){alert('Serper API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.\n\nhttps://serper.dev ì—ì„œ ë¬´ë£Œ ê°€ì… í›„ API Key ë³µì‚¬');return;}
  localStorage.setItem('sp4_cfg',JSON.stringify({skey:k}));
  updateDot(); closeApi();
}
function getKey(){try{return JSON.parse(localStorage.getItem('sp4_cfg')||'{}').skey||'';}catch(e){return '';}}
function updateDot(){
  const ok=!!getKey();
  document.getElementById('api-dot').className='dot'+(ok?' ok':'');
  document.getElementById('api-lbl').textContent=ok?'Serper API ì—°ê²°ë¨':'Serper API í‚¤ í•„ìš” (ë¬´ë£Œ)';
}
function saveSites(){
  localStorage.setItem('sp4_sites',JSON.stringify(
    [...document.querySelectorAll('.site-row')].map(r=>({
      url:r.dataset.url,
      on:r.querySelector('.cb').classList.contains('on')
    }))
  ));
}
function updateUsage(){
  const pct=Math.min(100,(usageCount/2500)*100);
  document.getElementById('usage-bar').style.display='block';
  document.getElementById('usage-cnt').textContent=`${usageCount.toLocaleString()} / 2,500`;
  document.getElementById('usage-fill').style.width=pct+'%';
  document.getElementById('usage-fill').style.background=
    pct>85?'linear-gradient(135deg,#e85454,#f59e0b)':
    pct>60?'linear-gradient(135deg,#f59e0b,#7c5cf6)':'var(--acg)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SITES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addSite(){
  const inp=document.getElementById('new-site');
  let url=inp.value.trim().replace(/^https?:\/\//,'').replace(/\/$/,'');
  if(!url)return;
  inp.value='';
  addToList(url,true); saveSites();
}
function addToList(url,on=true){
  if(document.querySelector(`[data-url="${CSS.escape(url)}"]`))return;
  const r=document.createElement('div');
  r.className='site-row'; r.dataset.url=url;
  r.innerHTML=`
    <div class="cb ${on?'on':''}" onclick="this.classList.toggle('on');saveSites()"></div>
    <span class="site-name" title="${esc(url)}">${esc(url)}</span>
    <button class="del-btn" onclick="this.closest('.site-row').remove();saveSites()">Ã—</button>`;
  document.getElementById('sites-list').appendChild(r);
}
function checkedSites(){
  return [...document.querySelectorAll('.cb.on')].map(el=>el.closest('.site-row').dataset.url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODE / SORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setMode(m){
  mode=m;
  document.getElementById('t-site').classList.toggle('on',m==='site');
  document.getElementById('t-gen').classList.toggle('on',m==='general');
  document.getElementById('sites-panel').style.display=m==='site'?'block':'none';
  document.getElementById('gen-panel').style.display=m==='general'?'block':'none';
}
function setSort(s){
  sort=s;
  ['rel','new','old'].forEach(k=>document.getElementById('s-'+k).classList.remove('on'));
  document.getElementById('s-'+s).classList.add('on');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• API PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleApi(){
  const b=document.getElementById('api-bd'),c=document.getElementById('api-caret');
  b.classList.toggle('open'); c.classList.toggle('open',b.classList.contains('open'));
}
function closeApi(){
  document.getElementById('api-bd').classList.remove('open');
  document.getElementById('api-caret').classList.remove('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DATE PARSING (í•µì‹¬ ìˆ˜ì •) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Serperì˜ date í•„ë“œ í˜•íƒœ:
   - "Dec 1, 2023"        â†’ ì ˆëŒ€ ë‚ ì§œ
   - "Jan 15, 2024"
   - "2 hours ago"        â†’ ìƒëŒ€ ë‚ ì§œ
   - "3 days ago"
   - "1 week ago"
   - "2 months ago"
   - "1 year ago"
   - ISO: "2024-01-15T..."
*/
const MON=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const MON_KR={jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};

function parseDate(s){
  if(!s) return null;
  const now=Date.now();
  const str=s.trim();

  // â”€â”€ ìƒëŒ€ ë‚ ì§œ ì²˜ë¦¬ â”€â”€
  const rel=str.match(/^(\d+)\s+(second|minute|hour|day|week|month|year)s?\s+ago$/i);
  if(rel){
    const n=parseInt(rel[1]);
    const unit=rel[2].toLowerCase();
    const ms={second:1000,minute:60000,hour:3600000,day:86400000,week:604800000,month:2592000000,year:31536000000};
    return new Date(now - n*(ms[unit]||0));
  }
  // "just now", "ì–´ì œ", etc
  if(/just now/i.test(str)) return new Date(now);
  if(/yesterday/i.test(str)) return new Date(now-86400000);

  // â”€â”€ ì ˆëŒ€ ë‚ ì§œ: "Dec 1, 2023" or "December 1, 2023" â”€â”€
  const abs=str.match(/^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})$/);
  if(abs){
    const m=MON_KR[abs[1].toLowerCase().slice(0,3)];
    if(m!==undefined) return new Date(parseInt(abs[3]),m,parseInt(abs[2]));
  }

  // â”€â”€ ISO / standard â”€â”€
  const d=new Date(str);
  return isNaN(d)?null:d;
}

function dateBadge(raw){
  const d=parseDate(raw);
  if(!d) return `<div class="dbadge"><div class="db-na">â€”</div></div>`;
  return `<div class="dbadge">
    <div class="db-d">${d.getDate()}</div>
    <div class="db-m">${MON[d.getMonth()]}</div>
    <div class="db-y">${d.getFullYear()}</div>
  </div>`;
}

function relAge(d){
  if(!d)return'';
  const diff=Date.now()-d.getTime(), days=Math.floor(diff/86400000);
  if(days===0)return'ì˜¤ëŠ˜';
  if(days===1)return'ì–´ì œ';
  if(days<7)return`${days}ì¼ ì „`;
  if(days<30)return`${Math.floor(days/7)}ì£¼ ì „`;
  if(days<365)return`${Math.floor(days/30)}ê°œì›” ì „`;
  return`${Math.floor(days/365)}ë…„ ì „`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function go(page=1){
  const key=getKey();
  if(!key){
    setOut(`<div class="err">âš ï¸ Serper API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•´ ì£¼ì„¸ìš”.<br><small>ì™¼ìª½ íŒ¨ë„ í´ë¦­ â†’ serper.dev ë¬´ë£Œ ê°€ì… â†’ í‚¤ ë³µì‚¬ â†’ ì €ì¥</small></div>`);
    toggleApi(); return;
  }

  const q=document.getElementById('q').value.trim();
  if(!q)return;

  // Build query
  let query=q;
  if(mode==='site'){
    const sites=checkedSites();
    if(!sites.length){setOut(`<div class="err">âš ï¸ ê²€ìƒ‰í•  ì‚¬ì´íŠ¸ë¥¼ í•˜ë‚˜ ì´ìƒ ì²´í¬í•´ ì£¼ì„¸ìš”.</div>`);return;}
    query=sites.length===1
      ?`site:${sites[0]} ${q}`
      :`(${sites.map(s=>`site:${s}`).join(' OR ')}) ${q}`;
  } else {
    query=`${q} ${NEWS.slice(0,15).map(s=>'-site:'+s).join(' ')}`;
  }

  setOut(`<div class="state"><div class="spin"></div><div class="state-sub">ê²€ìƒ‰ ì¤‘â€¦</div></div>`);
  document.getElementById('welcome').style.display='none';
  document.getElementById('go-btn').disabled=true;

  try{
    const body={q:query, num:10, page, hl:'ko', gl:'kr'};

    // ìµœì‹ ìˆœì¼ ë•Œ Googleì—ë„ ë‚ ì§œìˆœ ìš”ì²­
    if(sort==='new') body.tbs='sbd:1';

    const res=await fetch('https://google.serper.dev/search',{
      method:'POST',
      headers:{'X-API-KEY':key,'Content-Type':'application/json'},
      body:JSON.stringify(body),
    });

    if(!res.ok){
      const e=await res.json().catch(()=>({}));
      throw new Error(e?.message||`HTTP ${res.status}`);
    }

    const data=await res.json();
    usageCount++;
    localStorage.setItem('sp4_usage',usageCount);
    updateUsage();

    const items=(data.organic||[]).map(r=>({
      title:r.title||'',
      url:r.link||'',
      desc:r.snippet||'',
      rawDate:r.date||null,
      parsed:parseDate(r.date),
      domain:(()=>{try{return new URL(r.link).hostname;}catch(e){return r.link;}})(),
    }));

    // ë‚ ì§œ ì •ë ¬ (ë‚ ì§œ ì—†ëŠ” í•­ëª©ì€ í•­ìƒ ë§¨ ì•„ë˜ë¡œ)
    if(sort==='new'){
      items.sort((a,b)=>{
        if(!a.parsed&&!b.parsed)return 0;
        if(!a.parsed)return 1;
        if(!b.parsed)return -1;
        return b.parsed.getTime()-a.parsed.getTime(); // ë‚´ë¦¼ì°¨ìˆœ
      });
    } else if(sort==='old'){
      items.sort((a,b)=>{
        if(!a.parsed&&!b.parsed)return 0;
        if(!a.parsed)return 1;
        if(!b.parsed)return -1;
        return a.parsed.getTime()-b.parsed.getTime(); // ì˜¤ë¦„ì°¨ìˆœ
      });
    }

    const total=data.searchInformation?.totalResults
      ?parseInt(data.searchInformation.totalResults.replace(/,/g,''))
      :items.length;

    render(items,total,q,page);

  }catch(e){
    setOut(`<div class="err">âš ï¸ ${esc(e.message)}</div>`);
  }finally{
    document.getElementById('go-btn').disabled=false;
  }
}

function render(items,total,rawQ,page){
  document.getElementById('chips').style.display='flex';
  document.getElementById('cd-mode').style.background=mode==='site'?'var(--accent)':'var(--accent3)';
  document.getElementById('chip-mode-txt').textContent=
    mode==='site'?`ì‚¬ì´íŠ¸ ê²€ìƒ‰ (${checkedSites().length}ê°œ)`:'ì¼ë°˜ ê²€ìƒ‰ Â· ë‰´ìŠ¤ ì œì™¸';
  document.getElementById('chip-sort-txt').textContent=
    {rel:'ê´€ë ¨ë„ìˆœ',new:'ìµœì‹ ìˆœ',old:'ì˜¤ë˜ëœìˆœ'}[sort];

  if(!items.length){
    setOut(`<div class="state"><div class="state-ico">ğŸ”­</div><div class="state-title">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</div><div class="state-sub">ê²€ìƒ‰ì–´ë‚˜ ì‚¬ì´íŠ¸ ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</div></div>`);
    return;
  }

  const disp=total>1000000?'1,000,000+':total.toLocaleString();
  let html=`<div class="rinfo">
    <div class="rcnt">ì´ <strong>${disp}</strong>ê°œ ê²°ê³¼</div>
    <div class="rq">${esc(rawQ)}</div>
  </div>`;

  items.forEach((it,i)=>{
    html+=`<a class="card" href="${esc(it.url)}" target="_blank" rel="noopener" style="animation-delay:${i*.04}s">
      <div class="card-in">
        <div class="card-body">
          <div class="card-top">
            <span class="card-dom">ğŸŒ ${esc(it.domain)}</span>
            ${it.parsed?`<span class="card-rel">${relAge(it.parsed)}</span>`:''}
          </div>
          <div class="card-title">${esc(it.title)}</div>
          <div class="card-desc">${esc(it.desc)}</div>
        </div>
        ${dateBadge(it.rawDate)}
      </div>
    </a>`;
  });

  const maxP=Math.min(10,Math.ceil(Math.min(total,100)/10));
  if(maxP>1){
    html+=`<div class="pager">`;
    if(page>1)html+=`<button class="pg" onclick="go(${page-1})">â—€</button>`;
    for(let p=Math.max(1,page-2);p<=Math.min(maxP,page+2);p++)
      html+=`<button class="pg${p===page?' on':''}" onclick="go(${p})">${p}</button>`;
    if(page<maxP)html+=`<button class="pg" onclick="go(${page+1})">â–¶</button>`;
    html+=`</div>`;
  }
  setOut(html);
}

function setOut(h){document.getElementById('out').innerHTML=h;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

load();
</script>
</body>
</html>
